---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: crowdsec
spec:
  releaseName: crowdsec
  chart:
    spec:
      chart: crowdsec
      version: 0.9.6
      sourceRef:
        kind: HelmRepository
        name: crowdsec
        namespace: flux-system
  interval: 1h
  maxHistory: 3
  install:
    remediation:
      retries: 1
      remediateLastFailure: true
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 1
      remediateLastFailure: true
  uninstall:
    keepHistory: false
  test:
    enable: true
    ignoreFailures: false
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: crowdsec-lapi
            patch: |-
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: crowdsec-custom-config
                  configMap:
                    name: crowdsec-config
          - target:
              kind: Deployment
              name: crowdsec-lapi
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/volumeMounts/-
                value:
                  mountPath: /etc/crowdsec_data/config.yaml.local
                  subPath: config.yaml
                  name: crowdsec-custom-config
          - target:
              kind: Deployment
              name: crowdsec-lapi
            patch: |-
              - op: add
                path: /spec/replicas
                value: 2
  values:
    container_runtime: containerd
    lapi:
      env:
        - name: DISABLE_AGENT
          value: "true"
        - name: GID
          value: ""
        - name: DATABASE_TYPE
          value: pgx
        - name: POSTGRESQL_DATABASE
          valueFrom:
            secretKeyRef:
              key: database
              name: postgresql-credentials
        - name: POSTGRESQL_USERNAME
          valueFrom:
            secretKeyRef:
              key: username
              name: postgresql-credentials
        - name: POSTGRESQL_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: postgresql-credentials
        - name: BOUNCER_KEY_INGRESS_NGINX
          valueFrom:
            secretKeyRef:
              key: api-key
              name: crowdsec-lapi-credentials
      dashboard:
        enabled: true
        ingress:
          enabled: true
          ingressClassName: nginx
          annotations:
            cert-manager.io/cluster-issuer: cloudflare
            kubernetes.io/ingress.allow-http: "false"
            nginx.ingress.kubernetes.io/backend-protocol: HTTP
          host: crowdsec.${PRIMARY_DOMAIN}
          tls:
            - secretName: crowdsec-tls
              hosts:
                - crowdsec.${PRIMARY_DOMAIN}
      persistentVolume:
        data:
          enabled: true
          accessModes: [ReadWriteMany]
          storageClassName: rook-cephfs
          size: 1Gi
        config:
          enabled: true
          accessModes: [ReadWriteMany]
          storageClassName: rook-cephfs
          size: 100Mi
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
    agent:
      acquisition:
        - namespace: ingress-nginx
          podName: ingress-nginx-controller-*
          program: nginx
      env:
        - name: PARSERS
          value: >
            crowdsecurity/cri-logs
        - name: DISABLE_PARSERS
          value: >
            crowdsecurity/docker-logs
        - name: COLLECTIONS
          value: >
            crowdsecurity/linux
            crowdsecurity/nginx
            crowdsecurity/whitelist-good-actors
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
