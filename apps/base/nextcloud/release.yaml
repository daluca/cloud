---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: nextcloud
spec:
  releaseName: nextcloud
  chart:
    spec:
      chart: nextcloud
      sourceRef:
        kind: HelmRepository
        name: nextcloud
        namespace: flux-system
  interval: 1h
  timeout: 10m
  maxHistory: 3
  install:
    remediation:
      retries: 1
      remediateLastFailure: true
  upgrade:
    remediation:
      retries: 1
      remediateLastFailure: true
  uninstall:
    keepHistory: false
  test:
    enable: true
    ignoreFailures: false
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: nextcloud-metrics
            patch: |-
              - op: replace
                path: /spec/template/spec/containers/0/env/2/value
                value: http://nextcloud
  values:
    image:
      flavor: fpm-alpine
    replicaCount: 2
    ingress:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: cloudflare
        kubernetes.io/ingress.allow-http: "false"
        nginx.ingress.kubernetes.io/proxy-body-size: 4G
        # yamllint disable rule:line-length
        nginx.ingress.kubernetes.io/server-snippet: |-
          location ^~ /.well-known {
            location ~ /.well-known/(card|cal)dav { return 301 /remote.php/dav; }
            return 301 /index.php$request_uri;
          }
        # yamllint enable rule:line-length
      path: /
      tls:
        - secretName: nextcloud-tls
          hosts:
            - nextcloud.${PRIMARY_DOMAIN}
    nextcloud:
      host: nextcloud.${PRIMARY_DOMAIN}
      existingSecret:
        enabled: true
        secretName: nextcloud-credentials
        usernameKey: admin-username
        passwordKey: admin-password
      mail:
        enabled: true
        fromAddress: no-reply
        domain: nextcloud.${PRIMARY_DOMAIN}
        smtp:
          host: exim-relay.mail
          secure: ""
          port: 25
          authtype: NONE
      configs:
        # yamllint disable rule:line-length
        s3.config.php: |-
          <?php
          $CONFIG = array (
            'objectstore' => array(
              'class' => '\\OC\\Files\\ObjectStore\\S3',
              'arguments' => array(
                'hostname'             => 's3.ap-southeast-2.wasabisys.com',
                'bucket'               => getenv('WASABI_BUCKET'),
                'key'                  => getenv('WASABI_ACCESS_KEY_ID'),
                'secret'               => getenv('WASABI_SECRET_ACCESS_KEY'),
                'region'               => 'ap-southeast-2',
                'use_ssl'              => true,
                'use_path_style'       => true,
                'autocreate'           => false,
                'verify_bucket_exists' => true,
                'sse_c_key'            => getenv('AWS_SSE_CUSTOMER_KEY')
              )
            )
          );
        logging.config.php: |-
          <?php
          $CONFIG = array (
            'log_type' => 'file',
            'logfile'  => '/var/log/nextcloud/nextcloud.log',
            'loglevel' => 2,
          );
        proxy.config.php: |-
          <?php
          $CONFIG = array (
            'overwriteprotocol' => 'https',
            'overwrite.cli.url' => 'https://' . getenv('NEXTCLOUD_TRUSTED_DOMAINS'),
            'trusted_proxies' => array (
              0 => '127.0.0.1',
              1 => '10.0.0.0/8',
            ),
            'forwarded-for-headers' => array(
              0 => 'HTTP_X_FORWARDED_FOR',
              1 => 'HTTP_CF_CONNECTING-IP',
            ),
          );
        user-experience.config.php: |-
          <?php
          $CONFIG = array (
            'default_locale'       => 'en_NZ',
            'default_phone_region' => 'NZ',
            'hide_login_form'      => false,
            'skeletondirectory'    => '',
          );
        custom.config.php: |-
          <?php
          $CONFIG = array (
            'trusted_domains' => array (
              0 => 'localhost',
              1 => 'nextcloud',
              2 => 'nextcloud.nextcloud',
              3 => 'nextcloud.nextcloud.svc',
              4 => 'nextcloud.nextcloud.svc.cluster.local',
              5 => getenv('NEXTCLOUD_TRUSTED_DOMAINS')
            ),
          );
        # yamllint enable rule:line-length
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
      extraEnv:
        - name: WASABI_BUCKET
          valueFrom:
            secretKeyRef:
              name: wasabi-credentials
              key: bucket
        - name: WASABI_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: wasabi-credentials
              key: access-key
        - name: WASABI_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: wasabi-credentials
              key: secret-key
        - name: AWS_SSE_CUSTOMER_KEY
          valueFrom:
            secretKeyRef:
              name: wasabi-encryption
              key: sse-customer-key
        - name: REDIS_CLUSTER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-cluster-credentials
              key: password
        - name: PHP_MEMORY_LIMIT
          value: 512M
      extraVolumes:
        - name: logs
          emptyDir: {}
        - name: redis-cluster-config
          configMap:
            name: redis-cluster-config
      extraVolumeMounts:
        - name: logs
          mountPath: /var/log/nextcloud
        - name: redis-cluster-config
          mountPath: /usr/local/etc/php/conf.d/redis-session.ini
          subPath: redis-session.ini
    nginx:
      enabled: true
    internalDatabase:
      enabled: false
    externalDatabase:
      enabled: true
      name: nextcloud
      type: postgresql
      host: postgresql-cluster.database
      database: nextcloud
      existingSecret:
        secretName: postgresql-credentials
        usernameKey: nextcloud-username
        passwordKey: nextcloud-password
    cronjob:
      enabled: false
    service:
      port: 80
    persistence:
      enabled: true
      storageClass: rook-cephfs
      accessMode: ReadWriteMany
      size: 5Gi
    resources:
      limits:
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
    livenessProbe:
      enabled: true
    readinessProbe:
      enabled: true
    hpa:
      enabled: false
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
