---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-cluster-config
  namespace: nextcloud
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
data:
  redis-session.ini: |-
    [Session]
    session.save_handler=rediscluster
    session.save_path="seed[]=redis-cluster-leader.database:6379&timeout=2&read_timeout=2&failover=error&persistent=1&auth[pass]=${REDIS_CLUSTER_PASSWORD}"
    redis.session.locking_enabled=1
    redis.session.lock_retries=-1
    redis.session.lock_wait_time=10000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: post-installation-scripts
  namespace: nextcloud
data:
  00-debug.sh: |-
    #!/bin/sh

    echo "Running as $( whoami )"
  10-install-apps.sh: |-
    #!/bin/sh

    php ./occ app:install user_oidc
    php ./occ app:install contacts
    php ./occ app:install calendar
    php ./occ app:install tasks
    php ./occ app:install deck
  11-enable-apps.sh: |-
    #!/bin/sh

    php ./occ app:enable twofactor_totp
  12-disable-apps.sh: |-
    #!/bin/sh

    php ./occ app:disable contactsinteraction
  20-oidc-disable-other-logins.sh: |-
    #!/bin/sh

    php ./occ config:app:set user_oidc allow_multiple_user_backends --value=0
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: before-starting-scripts
  namespace: nextcloud
data:
  00-debug.sh: |-
    #!/bin/sh

    echo "Running as $( whoami )"
