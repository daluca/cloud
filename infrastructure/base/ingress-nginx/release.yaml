---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
spec:
  releaseName: ingress-nginx
  chart:
    spec:
      chart: ingress-nginx
      version: ">=4.10.0 <4.11.0"
      sourceRef:
        kind: HelmRepository
        name: ingress-nginx
        namespace: flux-system
  interval: 1h
  timeout: 10m
  maxHistory: 3
  install:
    remediation:
      retries: 1
      remediateLastFailure: true
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 1
      remediateLastFailure: true
  test:
    enable: true
    ignoreFailures: false
  uninstall:
    keepHistory: false
  values:
    controller:
      replicaCount: 3
      allowSnippetAnnotations: true
      podAnnotations:
        backup.velero.io/backup-volumes-excludes: crowdsec-bouncer-plugin
      service:
        externalTrafficPolicy: Local
        annotations:
          service.beta.kubernetes.io/do-loadbalancer-enable-proxy-protocol: "true"
          service.beta.kubernetes.io/do-loadbalancer-name: production
          service.beta.kubernetes.io/do-loadbalancer-hostname: ${PRIMARY_DOMAIN}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/component
                    operator: In
                    values: [app]
                  - key: app.kubernetes.io/instance
                    operator: In
                    values: [nextcloud]
                  - key: app.kubernetes.io/name
                    operator: In
                    values: [nextcloud]
              topologyKey: kubernetes.io/hostname
      config:
        force-ssl-redirect: "true"
        use-proxy-protocol: "true"
        use-forwarded-headers: "true"
        enable-real-ip: "true"
        proxy-real-ip-cidr: ${PRODUCTION_VPC_CIDR},${CLOUDFLARE_IPV4_RANGE},${CLOUDFLARE_IPV6_RANGE}
        forwarded-for-header: CF-Connecting-IP
        log-format-upstream: >-
          $host [$proxy_protocol_addr] $remote_addr - $remote_user
          [$time_local] "$request" $status $body_bytes_sent "$http_referer"
          "$http_user_agent" $request_length $request_time
          [$proxy_upstream_name] [$proxy_alternative_upstream_name]
          $upstream_addr $upstream_response_length $upstream_response_time
          $upstream_status $req_id
        server-snippet: |-
          real_ip_header CF-Connecting-IP;
    tcp:
      "5349": matrix/eturnal:5349
    udp:
      "3478": matrix/eturnal:3478
      "50001": matrix/eturnal:50001
      "50002": matrix/eturnal:50002
      "50003": matrix/eturnal:50003
      "50004": matrix/eturnal:50004
      "50005": matrix/eturnal:50005
      "50006": matrix/eturnal:50006
      "50007": matrix/eturnal:50007
      "50008": matrix/eturnal:50008
      "50009": matrix/eturnal:50009
      "50010": matrix/eturnal:50010
      "50011": matrix/eturnal:50011
      "50012": matrix/eturnal:50012
      "50013": matrix/eturnal:50013
      "50014": matrix/eturnal:50014
      "50015": matrix/eturnal:50015
      "50016": matrix/eturnal:50016
      "50017": matrix/eturnal:50017
      "50018": matrix/eturnal:50018
      "50019": matrix/eturnal:50019
      "50020": matrix/eturnal:50020
      "50021": matrix/eturnal:50021
      "50022": matrix/eturnal:50022
      "50023": matrix/eturnal:50023
      "50024": matrix/eturnal:50024
      "50025": matrix/eturnal:50025
      "50026": matrix/eturnal:50026
      "50027": matrix/eturnal:50027
      "50028": matrix/eturnal:50028
      "50029": matrix/eturnal:50029
      "50030": matrix/eturnal:50030
      "50031": matrix/eturnal:50031
      "50032": matrix/eturnal:50032
      "50033": matrix/eturnal:50033
      "50034": matrix/eturnal:50034
      "50035": matrix/eturnal:50035
      "50036": matrix/eturnal:50036
      "50037": matrix/eturnal:50037
      "50038": matrix/eturnal:50038
      "50039": matrix/eturnal:50039
      "50040": matrix/eturnal:50040
      "50041": matrix/eturnal:50041
      "50042": matrix/eturnal:50042
      "50043": matrix/eturnal:50043
      "50044": matrix/eturnal:50044
      "50045": matrix/eturnal:50045
      "50046": matrix/eturnal:50046
      "50047": matrix/eturnal:50047
      "50048": matrix/eturnal:50048
      "50049": matrix/eturnal:50049
      "50050": matrix/eturnal:50050
      "50051": matrix/eturnal:50051
      "50052": matrix/eturnal:50052
      "50053": matrix/eturnal:50053
      "50054": matrix/eturnal:50054
      "50055": matrix/eturnal:50055
      "50056": matrix/eturnal:50056
      "50057": matrix/eturnal:50057
      "50058": matrix/eturnal:50058
      "50059": matrix/eturnal:50059
      "50060": matrix/eturnal:50060
      "50061": matrix/eturnal:50061
      "50062": matrix/eturnal:50062
      "50063": matrix/eturnal:50063
      "50064": matrix/eturnal:50064
      "50065": matrix/eturnal:50065
      "50066": matrix/eturnal:50066
      "50067": matrix/eturnal:50067
      "50068": matrix/eturnal:50068
      "50069": matrix/eturnal:50069
      "50070": matrix/eturnal:50070
      "50071": matrix/eturnal:50071
      "50072": matrix/eturnal:50072
      "50073": matrix/eturnal:50073
      "50074": matrix/eturnal:50074
      "50075": matrix/eturnal:50075
      "50076": matrix/eturnal:50076
      "50077": matrix/eturnal:50077
      "50078": matrix/eturnal:50078
      "50079": matrix/eturnal:50079
      "50080": matrix/eturnal:50080
      "50081": matrix/eturnal:50081
      "50082": matrix/eturnal:50082
      "50083": matrix/eturnal:50083
      "50084": matrix/eturnal:50084
      "50085": matrix/eturnal:50085
      "50086": matrix/eturnal:50086
      "50087": matrix/eturnal:50087
      "50088": matrix/eturnal:50088
      "50089": matrix/eturnal:50089
      "50090": matrix/eturnal:50090
      "50091": matrix/eturnal:50091
      "50092": matrix/eturnal:50092
      "50093": matrix/eturnal:50093
      "50094": matrix/eturnal:50094
      "50095": matrix/eturnal:50095
      "50096": matrix/eturnal:50096
      "50097": matrix/eturnal:50097
      "50098": matrix/eturnal:50098
      "50099": matrix/eturnal:50099
      "50100": matrix/eturnal:50100
  valuesFrom:
    - kind: ConfigMap
      name: crowdsec-lua-plugin
      optional: true
